## Operator installer README

This document explains how to use the Operator installer (deployment script).

### Pre-reqs

* a running OpenShift or link:https://docs.okd.io/latest/minishift/index.html[Minishift] instance
* an active session (you should be logged in)
* cluster-admin privileges to register CRD and grant Operator service account cluster admin permissions
```
oc login --server=https://your.ip.address.here:8443 -u developer -p developer
```

### Quickstart

The simplest way to run the script is to use all the defaults.

The following command will grab config from custom-resource.yaml and start an installer image:

```
./deploy.sh --deploy
```

### Installation Configuration

The installer script will use command line args and `custom-resource.yaml` file to populate Operator CR spec fields.

#### Configuration

You can override default envs. Not all configuration parameters are available as flags. Run `./deploy.sh --help` to get a list of all available arguments.

`custom-resource.yaml` is a template with CR object holding spec fields that instruct the Operator on how exactly to deploy and configure CodeReady Workspaces.

#### Examples

##### Deploy with all defaults

The following command will grab config from custom-resource.yaml and start an installer image:

```
./deploy.sh --deploy
```
Specify a project/namespace:

```
./deploy.sh --deploy -p=mynamespace
```

#### Deploy without support of self signed certs, OpenShift OAuth and a custom server-image

```
./deploy.sh --deploy --server-image=myserver/image --version=latest --public-certs
```

##### Deploy with external Red Hat SSO:

In `custom-resource.yaml`:

```
auth:
  externalKeycloak: true
  keycloakURL: 'https://my-keycloak.com'
  keycloakRealm: 'myrealm'
  keycloakClientId: 'myClient'

```

##### Deploy with external Red Hat SSO and Postgres DB:

In `custom-resource.yaml`:

```
database:
  externalDb: true
  chePostgresHostname: 'http://postgres'
  chePostgresPort: '5432'
  chePostgresUser: 'myuser'
  chePostgresPassword: 'mypass'
  chePostgresDb: 'mydb'

....
auth:
  externalKeycloak: true
  keycloakURL: 'https://my-keycloak.com'
  keycloakRealm: 'myrealm'
  keycloakClientId: 'myClient'
```

### External DB and RH SSO Support

You can connect to external DB and RH SSO instances. The installer supports the following combinations:

* DB + RH SSO
* RH SSO alone

External DB + bundled RH SSO isn't currently supported. Provisioning of database and Keycloak realm and client happens only with bundled resources,
i.e. if you are connecting your own DB or Keycloak you need to pre-create resources. Refer to installation docs for more details.


## Upgrade from 1.0.1 to 1.1

Since 1.1.0 introduces an Operator that uses controller to watch custom resources there is no direct upgrade path. If you do not have any important workspaces/projects in an existing 1.0.1 namespace, it is better to delete it and deploy 1.1.

If you want to keep existing installation, it is possible to upgrade by deploying the operator to an existing namespace. There are a few pre-requisites before running the script:

1. Get current Postgres password from existing Postrges deployment environment > POSTGRESQL_PASSWORD, or run the following oc command:

```
oc get deployment postgres -o=jsonpath={'.spec.template.spec.containers[0].env[?(@.name=="POSTGRESQL_PASSWORD")].value'} -n $targetNamespace
```

2. Get current Keycloak admin username and password from existing Keycloak deployment environment > SSO_ADMIN_USERNAME and SSO_ADMIN_PASSWORD, or run the following oc command:


```
oc get deployment keycloak -o=jsonpath={'.spec.template.spec.containers[0].env[?(@.name=="SSO_ADMIN_USERNAME")].value'} -n $targetNamespace
oc get deployment keycloak -o=jsonpath={'.spec.template.spec.containers[0].env[?(@.name=="SSO_ADMIN_PASSWORD")].value'} -n $targetNamespace
```

If you have changed RH SSO admin password, provide an actual password rather than get it from env.

3. Set values in custom-resource.yaml with values you have previously obtained:

```
spec:
  database:
    chePostgresPassword: 'password'
  auth:
    keycloakAdminUserName: 'username'
    keycloakAdminPassword: 'password'
```

4. Optional. If you have configured OpenShift oAuth, get oAuth secret and set respective value in custom-resource.yaml:

To get a secret run as cluster admin:

```
oc get oauthclient openshift-identity-provider-h2fh -o=jsonpath={'.secret'}
```

Now add two fields to spec.auth, replace $secret with an actual secret, keep `oAuthClientName` the same:

```
spec:
  auth:
    oAuthClientName: 'openshift-identity-provider-h2fh'
    oAuthSecret: 'secret'

```

Save `custom-resource.yaml` and run the script with arguments that suit your installation.

## Uninstall

There's no dedicated function in the script that would uninstall CodeReady Workspaces, however, you can delete a custom resource which will delete all associated objects:

```
oc delete checluster/codeready -n $targetNamespace
```

where `$targetNamespace` is an OpenShift project with deployed CodeReady Workspaces (`workspaces` by default)
